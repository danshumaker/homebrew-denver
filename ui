#!/usr/bin/env bash
# Author: Dan Shumaker
# Date: 2025-12-31
#
# Denver (Developer Environment Manager) Installer/Uninstaller
#
# vim: ft=bash:

# Set script name based on file name.
_whoami="${0##*/}"
_whereami=$(dirname "$0")

# HEREDOCS + READ HELP FUNCTION
function help() {
  read -r -d '' HELP <<-START
    $_whoami  Installer for Developer Environment Manager (Denver)

    -h help        (print help)
    -v             (turn on verbose debugging)
    -u|--uninstall (uninstall everything or specified asset)
    --priv         (make repo private)
    --pub          (make repo public)
    -d|--dry-run   (dry run - do nothing but echo commands)
    -p|--prompt    (prompt before each command and wait for input)
    --clean        (remove all of denver)

    ASSETS
    --xcode        (install xcode only)
    --brew         (install homebrew)
    --denver       (install denver)
    --bundle       (bundle install)
    --dots         (dotfiles backup and linking)
    --shell        (change shell)
    --rust         (install rust)
    --php          (install php)

    Usage:

       $_whoami

       Without any arguments everything is installed without a prompt and with colored output.

    Requirements/Dependencies:
    - The repo is unlocked and public
    - curl
    - 1password (op authenticated)
    - gh (github tool authenticated)

    ✓ Kitty shell usage - setup verified
    ✓ Fonts Installed - (used nerd-font forumlas instead - possible powerline fonts install git clone https://github.com/powerline/fonts

    TODO:
     - Store Github token in 1pass
     - Convert to using GITHUB_TOKEN https://dev.to/jhot/homebrew-and-private-github-repositories-1dfh?utm_source=chatgpt.com"
     - Consolidate ui into install and uninstall into ui.
     - Configure 1Pass-cli .config/op/config
     - ^S^I in Tmux to picup installed plugins
     - .config/gh github authentication
     - configure .ssh do ssh-keygen but also convert to 1Pass-OP
     - Ensure docksal, colima, and terminus work
     - Ensure node and hugo work in resume theme
     - Ensure shutrail standsup

START

  echo ""
  echo "$HELP"
  echo ""
}

# Color terminal printing via associative arrays
declare -A colors
colors[BLACK]=$(tput setaf 0)
colors[RED]=$(tput setaf 1)
colors[GREEN]=$(tput setaf 2)
colors[YELLOW]=$(tput setaf 3)
colors[LIME_YELLOW]=$(tput setaf 190)
colors[POWDER_BLUE]=$(tput setaf 153)
colors[BLUE]=$(tput setaf 4)
colors[MAGENTA]=$(tput setaf 5)
colors[CYAN]=$(tput setaf 6)
colors[WHITE]=$(tput setaf 7)
declare -A styles
styles[BRIGHT]=$(tput bold)
styles[NORMAL]=$(tput sgr0)
styles[BLINK]=$(tput blink)
styles[REVERSE]=$(tput smso)
styles[UNDERLINE]=$(tput smul)

# usage: format, color, style, string
#   pp "%s" color bright "test this cyan color"
function pp() {
  ppargs=($@)
  printable="${ppargs[@]:3}"
  printf $1 "${colors[$2]}${styles[$3]}$printable${styles[NORMAL]}"
}

declare -i PROMPT=0
declare -i DRY=0
declare -i UNINSTALL=0

# ---------------- Detect OS -------------------
OS="$(uname -s)"
case "$OS" in
  Darwin) PLATFORM="macos" ;;
  Linux) PLATFORM="linux" ;;
  *) error "Unsupported OS: $OS" ;;
esac
info "Platform: $PLATFORM"

# Capture Arguements
argc=$#   # total args
argv=($@) # array of args

# Process CLI Settings
# - Go through the boolean only args and remove them so that They
#   do not confuse the command line options processing below.
for ((j = 0; j < argc; j++)); do
  case ${argv[j]} in
    -p | --prompt)
      PROMPT=1
      argv=("${argv[@]:0:$j}" "${argv[@]:($j + 1)}")
      argc=$(($argc - 1)) # two subtracted
      # Integer variable decrement - only decrement j because argc and argv
      # have been adjusted
      ((j--))
      ;;
    -d | --dry-run)
      DRY=1
      argv=("${argv[@]:0:$j}" "${argv[@]:($j + 1)}")
      argc=$(($argc - 1))
      ((j--))
      ;;
    -v)
      # Boolean Arguement
      argv=("${argv[@]:0:$j}" "${argv[@]:($j + 1)}")

      # Remove the arguement from the list of args
      argc=$(($argc - 1)) # decrement by 1
      ((j--))
      set -v
      set -x
      ;;
    -u | --uninstall)
      UNINSTALL=1
      argv=("${argv[@]:0:$j}" "${argv[@]:($j + 1)}")
      argc=$(($argc - 1)) # two subtracted
      # Integer variable decrement - only decrement j because argc and argv
      # have been adjusted
      ((j--))
      ;;
  esac
done

info() { pp "%s\n" CYAN NORMAL "[INFO] $*"; }
warn() { pp "%s\n" YELLOW BRIGHT "[WARN] $*"; }
ok() { pp "%s\n" GREEN BRIGHT "[SUCCESS] $*"; }

error() {
  pp "%s\n" RED BRIGHT "[ERROR] $*"
  exit 1
}

hide() {
  gh repo edit --visibility private --accept-visibility-change-consequences
}

unhide() {
  gh repo edit --visibility public --accept-visibility-change-consequences

}

run() {
  if (($DRY)); then
    echo "DRYRUN: $*"
  else
    if (($PROMPT)); then
      ring_bell
      echo "::RUN:: $@   ???"
      wait_for_user
      eval "$@"
    else
      eval "$@"
    fi
  fi
}

getc() {
  local save_state
  save_state="$(/bin/stty -g)"
  /bin/stty raw -echo
  IFS='' read -r -n 1 -d '' "$@"
  /bin/stty "${save_state}"
}

ring_bell() {
  # Use the shell's audible bell.
  if [[ -t 1 ]]; then
    printf "\a"
  fi
}

wait_for_user() {
  local c
  warn "Press RETURN/ENTER to continue or any other key to abort:"
  getc c
  # we test for \r and \n because some stuff does \r instead
  if ! [[ "${c}" == $'\r' || "${c}" == $'\n' ]]; then
    exit 1
  fi
}

# ----------------- xCode Developer Tools -------
xcode() {
  if [[ "$PLATFORM" == "macos" ]]; then
    if ! xcode-select -p >/dev/null 2>&1; then
      if (($UNINSTALL)); then
        ok "Xcode is not installed"
      else
        info "Installing Xcode Command Line Tools"
        run "xcode-select --install"
      fi
    else
      if (($UNINSTALL)); then
        run "sudo rm -rf /Library/Developer/CommandLineTools"
        ok "Xcode Command Line tools removed"
      else
        info "Xcode Command Line Tools are already installed."
      fi
    fi
  fi
}

# ----------------- Change Zsh to Bash default shell -------
change_shell() {
  info "Auditing shell configuration..."

  if [[ -z "${SHELL:-}" ]]; then
    error "\$SHELL is not set."
  fi

  if [[ ! -x "$SHELL" ]]; then
    error "\$SHELL points to a non-executable: $SHELL"
  fi

  if ! grep -qx "$SHELL" /etc/shells; then
    warn "\$SHELL ($SHELL) is not listed in /etc/shells"
  fi

  if command -v brew >/dev/null 2>&1; then

    info "Enforcing Homebrew bash as login shell..."

    BREW_BASH="$(brew --prefix)/bin/bash"

    if ! grep -qx "$BREW_BASH" /etc/shells; then
      info "Registering Homebrew bash in /etc/shells"
      echo "$BREW_BASH" | sudo tee -a /etc/shells >/dev/null
    fi

    if [[ "$SHELL" != "$BREW_BASH" ]]; then
      info "Changing login shell to $BREW_BASH"
      chsh -s "$BREW_BASH"
      ok "Login shell updated. Log out/in required."
    else
      ok "Homebrew bash already set as login shell"
    fi
  fi

}

# ---------------- Homebrew --------------
homebrew() {
  if ! command -v brew >/dev/null 2>&1; then
    if (($UNINSTALL)); then
      ok "Homebrew is not installed"
    else
      info "Installing Homebrew..."
      run '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    fi
  else
    if (($UNINSTALL)); then
      info "Uninstalling Homebrew"
      run '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"'
      exit 0
    else
      info "Homebrew already installed."
    fi
  fi

  # Load brew shellenv
  BREW_PREFIX="$(brew --prefix)"
  run 'eval "$($BREW_PREFIX/bin/brew shellenv)"'
}

# ---------------- Tap + Install formula ----------
denver() {
  if brew list --formula denver >/dev/null 2>&1; then
    if (($UNINSTALL)); then
      brew uninstall --zap --force denver 2>/dev/null || brew uninstall --force denver
      rm -rf "$(brew --cellar)/denver"
      rm -f "$(brew --prefix)/opt/denver"
      brew cleanup -s denver || true
      rm -f "$(brew --cache)"/denver--* 2>/dev/null || true
    else
      ok "Denver Installed"
    fi
  else
    if (($UNINSTALL)); then
      ok "denver is NOT installed"
    else
      run "brew tap danshumaker/denver"
      run "brew install denver"
    fi
  fi

  # ---------------- Verify Installation Success ----------------
  DENVER_PREFIX="$(brew --prefix denver || true)"
  PAYLOAD_DIR="$DENVER_PREFIX/share/denver"
  BREWFILE=$PAYLOAD_DIR/Brewfile
  DOTS=$PAYLOAD_DIR/dotfiles
  BACKUP_DIR="$HOME/.old_dots/backup_$(date +%Y%m%d_%H%M%S)"

  if [[ ! -d "$DENVER_PREFIX" ]]; then
    error "Denver prefix not found at: $DENVER_PREFIX"
  fi

  if [[ ! -d "$PAYLOAD_DIR" ]]; then
    error "Denver payload directory missing: $PAYLOAD_DIR"
  fi

  info "Denver payload detected at: $PAYLOAD_DIR"

  # ---------------- Verify Brewfile Exists ----------------

  if [[ ! -f "$BREWFILE" ]]; then
    error "Brewfile missing at: $BREWFILE"
  fi

}

# ---------------- Brew bundle --------------------
bundle() {
  if (($UNINSTALL)); then
    info "Uninstalling Homebrew formulas from Denver Brewfile..."
    # Locate Payload, check brew and denver dependencies
    command -v brew >/dev/null 2>&1 || error "Homebrew not installed."
    PREFIX="$(brew --prefix denver 2>/dev/null || true)"
    [[ -d "$PREFIX" ]] || error "denver payload not found."
    PAYLOAD="$PREFIX/share/denver"
    BREWFILE="$PAYLOAD/Brewfile"

    if [[ -f "$BREWFILE" ]]; then
      brew bundle list --file "$BREWFILE" --formula |
        xargs brew uninstall --ignore-dependencies || true

      brew bundle list --file "$BREWFILE" --cask |
        xargs brew uninstall --cask --force || true

      brew autoremove
      brew cleanup --prune=all
    else
      error "Denver Brewfile not found"
    fi
  else
    logfile="/tmp/brew-bundle.log"
    info "Running brew bundle using ${BREWFILE}…"
    set +e # we will handle errors manually
    brew bundle --upgrade --file="${BREWFILE}" 2>&1 | tee "${logfile}"
    status=${PIPESTATUS[0]}
    set -e
    if [[ $status -ne 0 ]]; then
      error "brew bundle failed (exit code ${status}). See ${logfile}"
    fi
    ok "Brew bundle finished successfully"
  fi

}

# ---------------- PHP Install --------------------
php_install() {
  info "Safe PHP install..."
  local logfile="/tmp/brew-install-php.log"

  info "Installing php…"

  # Run brew install and capture all output.
  # brew returns 0 even with warnings, so exit code is the only correct test.
  if ! brew install php >"${logfile}" 2>&1; then
    error "Fatal error installing php. See ${logfile}"
  fi

  # Validation: Did Brew actually install it?
  # brew list <formula> returns 1 if installation did NOT succeed.
  if ! brew list php >/dev/null 2>&1; then
    warn "Brew did not register php as installed."
    warn "This typically means a post-install failure."
    warn "See ${logfile}"
    error "Installation of php is incomplete."
  fi

  ok "php installed successfully (non-fatal Brew warnings ignored)"
}

# ---------------- Dotfile backup and Linking -------
dotfiles() {
  if (($UNINSTALL)); then
    if command -v rcdn >/dev/null 2>&1; then
      info "Removing Dotfile RCM symlinks..."
      cd "$HOME"
      run "rcdn -v -d \"$PAYLOAD\"/dotfiles"
    else
      warn "rcdn not found — cannot remove rcup symlinks."
    fi
    if [[ -d "$HOME/.old_dots" ]]; then
      LAST_BACKUP="$(ls -1dt "$HOME/.old_dots"/* 2>/dev/null | head -1)"
      if [[ -d "$LAST_BACKUP" ]]; then
        info "Restoring backup from $LAST_BACKUP"
        run "cp -R \"$LAST_BACKUP/.\" \"$HOME/\""
      else
        warn "No backups found inside ~/.old_dots"
      fi
    else
      warn "~/.old_dots does not exist; no backups to restore."
    fi
  else
    # ---------------- Backup dotfiles ----------------
    run "mkdir -p \"$BACKUP_DIR\""

    info "Backing up existing dotfiles... to $BACKUP_DIR"

    files=$(find "$DOTS" -type f -depth 1)
    for f in ${files[@]}; do
      rootFName=$HOME/.$(basename $f)
      if [[ -e "$rootFName" ]]; then
        if [[ -L "$rootFName" ]]; then
          # If it's a link then do NOT back it up but remove it so new links can be made
          run "rm -v \"$rootFName\""
        else
          run "mv -v \"$rootFName\" \"$BACKUP_DIR/\""
        fi
      fi
    done

    info "Running rcup..."
    cd $HOME
    run "ln -s \"$DOTS\"/rcrc $HOME/.rcrc"
    run "rcup -v -d \"$DOTS\""
    if [[ ! -L $HOME/.bash_profile ]]; then
      error "RCM up did not link dotfiles."
    else
      ok "Dotfiles installed"
      lsrc -d "$DOTS"
    fi
  fi
}

# ---------------- Install Rust --------------------
rust_install() {
  if ! command -v cargo >/dev/null 2>&1; then
    info "Installing Rust/Cargo toolchain..."
    run 'curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y'
  else
    info "Rust already installed."
  fi
}

cd $HOME
# Process Commands
for ((j = 0; j < argc; j++)); do
  case ${argv[j]} in
    -h)
      # Function call
      help
      exit
      ;;
    --xcode)
      xcode
      exit
      ;;
    --brew)
      homebrew
      exit
      ;;
    --denver)
      denver
      exit
      ;;
    --bundle)
      bundle
      exit
      ;;
    --shell)
      change_shell
      exit
      ;;
    --rust)
      rust_install
      exit
      ;;
    --php)
      php_install
      exit
      ;;
    --font)
      font_install
      exit
      ;;
    --dots)
      dotfiles
      exit
      ;;
    --priv)
      hide
      ;;
    --pub)
      unhide
      ;;
    *)
      pp "%s" RED "Invalid Option ${argv[j]}"
      help
      exit
      ;;
  esac
done

if (($UNINSTALL)); then
  php_install
  rust_install
  change_shell
  dotfiles
  bundle
  denver
  homebrew
  xcode
else
  # INSTALL DEFAULT
  xcode
  homebrew
  denver
  bundle
  dotfiles
  change_shell
  rust_install
  php_install
  ok "Denver installation complete."
fi
